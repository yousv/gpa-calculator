<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HNU - AHST GPA Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/inter-ui/3.19.3/inter.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #09090b;
        color: #fafafa;
        -webkit-tap-highlight-color: transparent;
      }

      .semester-content {
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.2s ease-in;
        max-height: 2000px;
        opacity: 1;
        overflow: hidden;
      }
      .semester-content.collapsed {
        max-height: 0;
        opacity: 0;
        pointer-events: none;
      }

      .chevron {
        transition: transform 0.3s ease;
      }
      .collapsed .chevron {
        transform: rotate(-90deg);
      }

      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      .text-excellent {
        color: #4ade80;
      }
      .text-good {
        color: #60a5fa;
      }
      .text-average {
        color: #fbbf24;
      }
      .text-poor {
        color: #f87171;
      }

      .bg-excellent {
        background-color: #064e3b;
        color: #4ade80;
      }
      .bg-good {
        background-color: #1e3a8a;
        color: #93c5fd;
      }
      .bg-average {
        background-color: #713f12;
        color: #fde047;
      }
      .bg-poor {
        background-color: #7f1d1d;
        color: #fca5a5;
      }

      .semester-card {
        transition: border-color 0.3s ease, background-color 0.3s ease;
      }
      .semester-card:not(.is-collapsed) {
        border-color: #27272a;
        background-color: #0c0c0e;
      }

      #import-modal {
        backdrop-filter: blur(8px);
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <header
      class="bg-zinc-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-zinc-800"
    >
      <div
        class="container mx-auto max-w-xl px-4 py-3 flex justify-between items-center"
      >
        <div class="overflow-hidden mr-2">
          <h1 class="text-base font-bold text-zinc-100 truncate">HNU - AHST</h1>
          <p
            class="text-[9px] text-zinc-500 uppercase tracking-widest font-medium truncate"
          >
            Medical Laboratory
          </p>
        </div>

        <div class="text-right flex-shrink-0">
          <div
            class="text-[9px] uppercase tracking-wider text-zinc-500 font-bold"
          >
            Total GPA
          </div>
          <div
            id="cgpa-display"
            class="text-2xl font-black text-zinc-100 tabular-nums leading-tight"
          >
            0.00
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 container mx-auto max-w-xl px-3 py-6">
      <div class="flex justify-between items-center mb-4 px-1">
        <h2
          class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest"
        >
          Academic Records
        </h2>
        <div class="flex gap-1.5">
          <button
            onclick="app.openImportModal()"
            class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold uppercase tracking-wider py-1.5 px-3 rounded-md transition active:scale-95 shadow-lg shadow-blue-900/20"
          >
            Smart Import
          </button>
          <button
            id="toggle-all"
            class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] font-bold uppercase tracking-wider py-1.5 px-3 rounded-md border border-zinc-700 transition active:scale-95"
          >
            Expand
          </button>
          <button
            id="reset-grades"
            class="bg-zinc-900 hover:bg-red-950/30 text-red-500 text-[10px] font-bold uppercase tracking-wider py-1.5 px-3 rounded-md border border-red-900/30 transition active:scale-95"
          >
            Reset
          </button>
        </div>
      </div>

      <div id="semesters-container" class="space-y-3"></div>
    </main>

    <div
      id="import-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/60"
    >
      <div
        class="bg-zinc-900 border border-zinc-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden"
      >
        <div class="p-6">
          <h3 class="text-lg font-bold text-zinc-100 mb-2">Portal Import</h3>
          <p class="text-sm text-zinc-400 mb-4">
            Go to <b>Final Grades</b> on the HNU portal, copy all text, and
            paste it here.
          </p>
          <textarea
            id="import-area"
            class="w-full h-48 bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-xs text-zinc-300 font-mono focus:ring-1 focus:ring-blue-500 outline-none resize-none"
            placeholder="Paste portal text here..."
          ></textarea>

          <div class="flex gap-3 mt-6">
            <button
              onclick="app.closeImportModal()"
              class="flex-1 px-4 py-3 rounded-xl bg-zinc-800 text-zinc-300 font-bold text-sm hover:bg-zinc-700 transition"
            >
              Cancel
            </button>
            <button
              onclick="app.processImport()"
              class="flex-1 px-4 py-3 rounded-xl bg-blue-600 text-white font-bold text-sm hover:bg-blue-500 transition"
            >
              Extract Grades
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer class="border-t border-zinc-900/50 py-6">
      <div class="container mx-auto text-center px-4">
        <p
          class="text-[10px] text-zinc-600 uppercase tracking-widest font-medium"
        >
          Developed by Yousef Khaled Ibrahim
        </p>
      </div>
    </footer>

    <script>
      class GPACalculator {
        constructor() {
          this.currentCGPA = 0;
          this.isAllExpanded = false;
          this.defaultSemesters = [
            {
              id: 1,
              title: "1st Year - Sem 1",
              courses: [
                {
                  code: "UN101",
                  name: "Academic Reading & Writing (1)",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS101",
                  name: "Basic Physics",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS102",
                  name: "Mathematics",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS103",
                  name: "Intro to Electrical Eng.",
                  credits: 3,
                  maxGrade: 150,
                },
                {
                  code: "UN102",
                  name: "Computer Skills",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS104",
                  name: "Mechanics",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "UN103",
                  name: "Critical thinking",
                  credits: 2,
                  maxGrade: 100,
                },
              ],
            },
            {
              id: 2,
              title: "1st Year - Sem 2",
              courses: [
                {
                  code: "THS115",
                  name: "Electronic Circuits & Devices",
                  credits: 3,
                  maxGrade: 150,
                },
                {
                  code: "THS116",
                  name: "General Anatomy & Histology",
                  credits: 3,
                  maxGrade: 150,
                },
                {
                  code: "THS117",
                  name: "General Physiology",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS118",
                  name: "General Microbiology",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS119",
                  name: "General Chemistry",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "UN114",
                  name: "Academic Reading & Writing (2)",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS1110",
                  name: "Professional Ethics",
                  credits: 1,
                  maxGrade: 50,
                },
                {
                  code: "UN30",
                  name: "Social Issues",
                  credits: 2,
                  maxGrade: 50,
                },
              ],
            },
            {
              id: 3,
              title: "Summer Courses",
              courses: [
                {
                  code: "THS102",
                  name: "Mathematics (Repeat)",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS104",
                  name: "Mechanics (Repeat)",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "THS115",
                  name: "Electronics (Repeat)",
                  credits: 3,
                  maxGrade: 150,
                },
              ],
            },
            {
              id: 4,
              title: "2nd Year - Sem 1",
              courses: [
                {
                  code: "THS2010",
                  name: "Mechatronics Engineering",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "TL201",
                  name: "Biochemistry",
                  credits: 4,
                  maxGrade: 200,
                },
                {
                  code: "TL202",
                  name: "Parasitology (1)",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "TL203",
                  name: "Bacteriology",
                  credits: 4,
                  maxGrade: 200,
                },
                {
                  code: "TL204",
                  name: "Histology for Lab",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "UN5",
                  name: "Digital Technology Foundation",
                  credits: 2,
                  maxGrade: 100,
                },
                {
                  code: "UN6",
                  name: "English Language 3",
                  credits: 2,
                  maxGrade: 100,
                },
              ],
            },
            {
              id: 5,
              title: "2nd Year - Sem 2",
              courses: [
                {
                  code: "TL215",
                  name: "Molecular Biology",
                  credits: 4,
                  maxGrade: 200,
                },
                {
                  code: "TL216",
                  name: "Hematology (1)",
                  credits: 4,
                  maxGrade: 200,
                },
                {
                  code: "TL217",
                  name: "Systematic Physiology",
                  credits: 4,
                  maxGrade: 200,
                },
                {
                  code: "TL218",
                  name: "General Biology",
                  credits: 3,
                  maxGrade: 150,
                },
                {
                  code: "ETHS15",
                  name: "Basic Life Support",
                  credits: 1,
                  maxGrade: 50,
                },
              ],
            },
          ];
          this.init();
        }

        init() {
          this.renderSemesters();
          this.attachGlobalListeners();
          this.calculateCGPA(false);
        }

        renderSemesters() {
          const container = document.getElementById("semesters-container");
          container.innerHTML = "";
          const storedGrades = this.loadGradesFromStorage() || [];

          this.defaultSemesters.forEach((semester, index) => {
            const semesterDiv = document.createElement("div");
            semesterDiv.className =
              "semester-card bg-zinc-900 rounded-lg border border-zinc-800 overflow-hidden is-collapsed";
            semesterDiv.innerHTML = `
                        <button class="semester-header w-full flex justify-between items-center p-4 hover:bg-zinc-800/40 transition-colors text-left collapsed" onclick="app.toggleSemester(this)">
                            <div class="flex items-center gap-3 overflow-hidden mr-2">
                                <span class="chevron text-zinc-600 text-[9px] flex-shrink-0">â–¼</span>
                                <h3 class="font-bold text-zinc-100 text-[13px] tracking-tight truncate">${
                                  semester.title
                                }</h3>
                            </div>
                            <div class="semester-gpa-badge text-[10px] font-black px-2.5 py-1 rounded-full bg-zinc-800 text-zinc-400 min-w-[3rem] text-center border border-zinc-700/50 flex-shrink-0">
                                -
                            </div>
                        </button>
                        <div class="semester-content collapsed">
                            <div class="px-4 pb-4 pt-0 space-y-1 border-t border-zinc-800/50 mt-1">
                                ${semester.courses
                                  .map((course, courseIdx) => {
                                    const savedVal =
                                      storedGrades[index]?.[courseIdx] || "";
                                    return this.renderCourseRow(
                                      course,
                                      index,
                                      courseIdx,
                                      savedVal
                                    );
                                  })
                                  .join("")}
                            </div>
                        </div>
                    `;
            container.appendChild(semesterDiv);
          });
        }

        renderCourseRow(course, semIdx, courseIdx, value) {
          return `
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 py-3 border-b border-zinc-800/40 last:border-0">
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-center gap-1.5 mb-0.5">
                                <span class="font-bold text-zinc-200 text-xs uppercase tracking-tight">${course.name}</span>
                                <span class="text-[8px] px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-500 font-bold border border-zinc-700/30 whitespace-nowrap">${course.credits} CR</span>
                            </div>
                            <div class="text-[9px] text-zinc-600 font-bold tracking-wider uppercase">${course.code}</div>
                        </div>
                        <div class="flex items-center self-end sm:self-center gap-2 bg-zinc-950 border border-zinc-800 rounded-lg px-2.5 py-1.5 focus-within:ring-1 focus-within:ring-zinc-600">
                            <input 
                                type="number" 
                                class="grade-input w-14 bg-transparent text-center text-sm font-black text-zinc-100 outline-none" 
                                placeholder="0" 
                                data-code="${course.code}"
                                data-sem-idx="${semIdx}"
                                data-course-idx="${courseIdx}"
                                data-max="${course.maxGrade}"
                                value="${value}"
                                oninput="app.handleInput(this)"
                            >
                            <span class="text-[9px] font-bold text-zinc-700 select-none">/ ${course.maxGrade}</span>
                        </div>
                    </div>
                `;
        }

        openImportModal() {
          document.getElementById("import-modal").classList.remove("hidden");
          document.getElementById("import-area").value = "";
        }

        closeImportModal() {
          document.getElementById("import-modal").classList.add("hidden");
        }

        processImport() {
          const text = document.getElementById("import-area").value;
          if (!text.trim()) return;

          const inputs = document.querySelectorAll(".grade-input");
          let foundCount = 0;

          inputs.forEach((input) => {
            const code = input.dataset.code;
            const regex = new RegExp(
              code + "[^]*?(\\d+(?:\\.\\d+)?)\\s*\\/",
              "i"
            );
            const match = text.match(regex);

            if (match && match[1]) {
              input.value = match[1];
              foundCount++;
            }
          });

          this.saveGrades();
          this.calculateCGPA(true);
          this.closeImportModal();

          if (foundCount > 0) {
            this.renderSemesters();
            this.calculateCGPA(false);
          } else {
            alert("Could not extract any grades.");
          }
        }

        /**
         * Accordion Logic: Toggles target and collapses all others
         */
        toggleSemester(headerBtn) {
          const card = headerBtn.closest(".semester-card");
          const content = headerBtn.nextElementSibling;
          const isExpanding = content.classList.contains("collapsed");

          // If we are expanding this semester, collapse all others first
          if (isExpanding) {
            document.querySelectorAll(".semester-card").forEach((otherCard) => {
              if (otherCard !== card) {
                const otherHeader = otherCard.querySelector(".semester-header");
                const otherContent =
                  otherCard.querySelector(".semester-content");

                otherHeader.classList.add("collapsed");
                otherContent.classList.add("collapsed");
                otherCard.classList.add("is-collapsed");
              }
            });
          }

          // Toggle the clicked one
          content.classList.toggle("collapsed");
          headerBtn.classList.toggle("collapsed");
          card.classList.toggle("is-collapsed");

          this.updateToggleAllButton();
        }

        /**
         * Bulk expand/collapse
         */
        toggleAll() {
          this.isAllExpanded = !this.isAllExpanded;
          document.querySelectorAll(".semester-card").forEach((card) => {
            const header = card.querySelector(".semester-header");
            const content = card.querySelector(".semester-content");

            content.classList.toggle("collapsed", !this.isAllExpanded);
            header.classList.toggle("collapsed", !this.isAllExpanded);
            card.classList.toggle("is-collapsed", !this.isAllExpanded);
          });
          this.updateToggleAllButton();
        }

        updateToggleAllButton() {
          const someExpanded = Array.from(
            document.querySelectorAll(".semester-content")
          ).some((el) => !el.classList.contains("collapsed"));
          this.isAllExpanded = someExpanded;
          document.getElementById("toggle-all").textContent = this.isAllExpanded
            ? "Collapse"
            : "Expand";
        }

        resetGrades() {
          if (!confirm("Wipe all data?")) return;
          localStorage.removeItem("gpa-grades-hnu");
          document
            .querySelectorAll(".grade-input")
            .forEach((input) => (input.value = ""));
          this.calculateCGPA(true);
        }

        handleInput(input) {
          let val = parseFloat(input.value);
          const max = parseFloat(input.dataset.max);
          if (val > max) input.value = max;
          if (val < 0) input.value = 0;

          clearTimeout(this.inputTimeout);
          this.inputTimeout = setTimeout(() => {
            this.saveGrades();
            this.calculateCGPA(true);
          }, 200);
        }

        calculateCGPA(animate = true) {
          let totalPoints = 0,
            totalCredits = 0;
          const semesters = this.defaultSemesters;

          document.querySelectorAll(".semester-card").forEach((card, idx) => {
            let semPoints = 0,
              semCredits = 0;
            card.querySelectorAll(".grade-input").forEach((input, cIdx) => {
              const val = parseFloat(input.value);
              const course = semesters[idx].courses[cIdx];
              if (!isNaN(val)) {
                semPoints += (val / course.maxGrade) * 4.0 * course.credits;
                semCredits += course.credits;
              }
            });

            const badge = card.querySelector(".semester-gpa-badge");
            if (semCredits > 0) {
              const gpa = semPoints / semCredits;
              badge.textContent = gpa.toFixed(2);
              this.applyColor(badge, gpa, true);
            } else {
              badge.textContent = "-";
              badge.className =
                "semester-gpa-badge text-[10px] font-black px-2.5 py-1 rounded-full bg-zinc-800 text-zinc-400 min-w-[3rem] text-center border border-zinc-700/50 flex-shrink-0";
            }
            totalPoints += semPoints;
            totalCredits += semCredits;
          });

          const display = document.getElementById("cgpa-display");
          const newCGPA = totalCredits > 0 ? totalPoints / totalCredits : 0;

          if (animate) {
            this.animateValue(display, this.currentCGPA, newCGPA, 400);
          } else {
            display.textContent = newCGPA.toFixed(2);
          }
          this.currentCGPA = newCGPA;

          if (totalCredits > 0) {
            this.applyColor(display, newCGPA, false);
          } else {
            display.className =
              "text-2xl font-black text-zinc-100 tabular-nums leading-tight";
          }
        }

        animateValue(obj, start, end, duration) {
          let startTimestamp = null;
          const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min(
              (timestamp - startTimestamp) / duration,
              1
            );
            obj.innerHTML = (progress * (end - start) + start).toFixed(2);
            if (progress < 1) window.requestAnimationFrame(step);
          };
          window.requestAnimationFrame(step);
        }

        applyColor(el, gpa, isBg) {
          el.classList.remove(
            "text-excellent",
            "text-good",
            "text-average",
            "text-poor",
            "bg-excellent",
            "bg-good",
            "bg-average",
            "bg-poor",
            "text-zinc-100",
            "text-zinc-400",
            "bg-zinc-800"
          );
          let type =
            gpa >= 3.4
              ? "excellent"
              : gpa >= 2.8
              ? "good"
              : gpa >= 2.0
              ? "average"
              : "poor";
          el.classList.add(isBg ? `bg-${type}` : `text-${type}`);
        }

        saveGrades() {
          const grades = Array.from(
            { length: this.defaultSemesters.length },
            () => []
          );
          document.querySelectorAll(".grade-input").forEach((input) => {
            grades[input.dataset.semIdx][input.dataset.courseIdx] = input.value;
          });
          localStorage.setItem("gpa-grades-hnu", JSON.stringify(grades));
        }

        loadGradesFromStorage() {
          try {
            return JSON.parse(localStorage.getItem("gpa-grades-hnu"));
          } catch {
            return null;
          }
        }

        attachGlobalListeners() {
          document
            .getElementById("toggle-all")
            .addEventListener("click", () => this.toggleAll());
          document
            .getElementById("reset-grades")
            .addEventListener("click", () => this.resetGrades());
        }
      }

      const app = new GPACalculator();
    </script>
  </body>
</html>
